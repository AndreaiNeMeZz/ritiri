<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ritiri Emotiva</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Custom Styles for Emotiva Brand */
        :root {
            --emotiva-purple: #9c6da5;
            --emotiva-purple-dark: #8a5f93;
            --emotiva-purple-light: #f4eff6;
            --emotiva-green: #5cb85c;
            --emotiva-green-dark: #4a934a;
            --emotiva-text-dark-bg: #EAEAEA; /* Light gray text for dark backgrounds */
            --emotiva-text-light-bg: #333; /* Dark text for light backgrounds (cards) */
        }

        /* Set a transparent background to blend with the parent site */
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: transparent;
            color: var(--emotiva-text-dark-bg);
        }

        .btn-primary {
            background-color: var(--emotiva-purple); color: white; transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(156, 109, 165, 0.39);
        }
        .btn-primary:hover {
            background-color: var(--emotiva-purple-dark); transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(156, 109, 165, 0.5);
        }
        
        .btn-secondary {
            background-color: var(--emotiva-green); color: white; transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(92, 184, 92, 0.39);
        }
        .btn-secondary:hover {
            background-color: var(--emotiva-green-dark); transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(92, 184, 92, 0.5);
        }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333;
            color: #fff; text-align: center; border-radius: 8px; padding: 16px;
            position: fixed; z-index: 100; left: 50%; bottom: 30px; opacity: 0;
            transition: all 0.5s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 50; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; }
        
        /* Glassmorphism card style */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        input, textarea {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: var(--emotiva-text-dark-bg) !important;
        }
        input::placeholder, textarea::placeholder {
            color: #a0aec0 !important;
        }
        input:focus, textarea:focus { border-color: var(--emotiva-purple) !important; box-shadow: 0 0 0 2px rgba(156, 109, 165, 0.5) !important; }
        
        .tab-button.active { border-color: var(--emotiva-purple); color: var(--emotiva-purple); }
    </style>
</head>
<body class="antialiased">

    <div class="w-full mx-auto px-4">
        <header class="text-center mb-8 pt-8">
            <img src="logo.png" alt="Logo Emotiva" class="mx-auto mb-4 h-12">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Piattaforma Ritiri</h1>
        </header>

        <main id="app-container">
            <!-- Role Selection View -->
            <div id="role-selection-view" class="view active text-center glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-white">Seleziona il tuo ruolo</h2>
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button onclick="showView('admin-login-view')" class="btn-primary font-bold py-3 px-6 rounded-lg"><i class="fas fa-user-shield mr-2"></i> Coordinatore / Magazzino</button>
                    <button onclick="showView('client-login-view')" class="btn-secondary font-bold py-3 px-6 rounded-lg"><i class="fas fa-user mr-2"></i> Cliente</button>
                </div>
            </div>

            <!-- Admin Login View -->
            <div id="admin-login-view" class="view glass-card p-8">
                <button onclick="showView('role-selection-view')" class="text-emotiva-purple hover:underline mb-4"><i class="fas fa-arrow-left mr-2"></i>Torna indietro</button>
                <h2 class="text-2xl font-semibold mb-4 text-center text-white">Accesso Area Riservata</h2>
                <input type="password" id="admin-password" placeholder="Inserisci password" class="w-full p-3 rounded-lg mb-4 transition">
                <button id="admin-login-button" onclick="loginAdmin()" class="w-full btn-primary font-bold py-3 px-6 rounded-lg">Accedi</button>
            </div>

            <!-- Client Login View -->
            <div id="client-login-view" class="view glass-card p-8">
                <button onclick="showView('role-selection-view')" class="text-emotiva-purple hover:underline mb-4"><i class="fas fa-arrow-left mr-2"></i>Torna indietro</button>
                <h2 class="text-2xl font-semibold mb-4 text-center text-white">Accesso Cliente</h2>
                <p class="text-center text-gray-400 mb-4">Inserisci il codice univoco per gestire il tuo ritiro.</p>
                <input type="text" id="client-code" placeholder="Il tuo codice di ritiro" class="w-full p-3 rounded-lg mb-4 transition">
                <button onclick="loginClient()" class="w-full btn-secondary font-bold py-3 px-6 rounded-lg">Verifica Codice</button>
            </div>

            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="view">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Pannello di Controllo</h2>
                        <p id="warehouse-name" class="text-lg" style="color: var(--emotiva-purple);"></p>
                    </div>
                    <button onclick="logout()" class="text-red-400 hover:text-red-500 hover:underline">Esci</button>
                </div>
                
                <div id="add-pickup-container" class="glass-card p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-white">Aggiungi Materiale Cliente</h3>
                    <form id="add-pickup-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <h4 class="md:col-span-2 text-lg font-medium text-gray-300 border-b border-gray-700 pb-2">Cliente</h4>
                        <input type="text" id="client-name" placeholder="Fiera" class="p-3 rounded-lg transition" required>
                        <input type="text" id="client-stand" placeholder="Cliente/Stand" class="p-3 rounded-lg transition" required>
                        
                        <h4 class="md:col-span-2 text-lg font-medium text-gray-300 mt-4 border-b border-gray-700 pb-2">Dati Spedizione</h4>
                        <input type="number" id="pallet-count" placeholder="Numero Bancali/Colli" class="p-3 rounded-lg transition" required min="1">
                        <div id="packages-container" class="md:col-span-2 grid grid-cols-1 gap-y-4"></div>
                        <textarea id="pallet-desc" placeholder="Descrizione contenuto" class="p-3 rounded-lg md:col-span-2 transition" rows="2"></textarea>
                        
                        <h4 class="md:col-span-2 text-lg font-medium text-gray-300 mt-4 border-b border-gray-700 pb-2">Dati per il Corriere</h4>
                        <textarea id="pickup-address" placeholder="Indirizzo di ritiro completo" class="p-3 rounded-lg md:col-span-2 transition" rows="3" required></textarea>
                        <input type="text" id="pickup-contact-name" placeholder="Nome referente magazzino" class="p-3 rounded-lg transition">
                        <input type="tel" id="pickup-contact-phone" placeholder="Telefono referente" class="p-3 rounded-lg transition">
                        
                        <h4 class="md:col-span-2 text-lg font-medium text-gray-300 mt-4 border-b border-gray-700 pb-2">Proponi Date di Ritiro (Opzionale)</h4>
                        <input type="datetime-local" id="initial-date-1" class="p-3 rounded-lg transition">
                        <input type="datetime-local" id="initial-date-2" class="p-3 rounded-lg transition">
                        <input type="datetime-local" id="initial-date-3" class="p-3 rounded-lg md:col-span-2 transition">

                        <button type="submit" class="md:col-span-2 w-full btn-primary font-bold py-3 px-6 rounded-lg mt-4">Aggiungi e Genera Codice</button>
                    </form>
                </div>
                
                <div>
                    <div class="border-b border-gray-700">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-ongoing" onclick="showTab('ongoing')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active">In corso</button>
                            <button id="tab-completed" onclick="showTab('completed')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Completati</button>
                        </nav>
                    </div>
                    <div id="tab-content-ongoing" class="tab-content active"><div id="pickups-list-ongoing" class="space-y-4 mt-6"></div></div>
                    <div id="tab-content-completed" class="tab-content" style="display: none;"><div id="pickups-list-completed" class="space-y-4 mt-6"></div></div>
                </div>
            </div>

            <!-- Client View -->
            <div id="client-view" class="view">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white" id="client-view-title">Dettagli Ritiro</h2>
                    <button onclick="logout()" class="text-red-400 hover:text-red-500 hover:underline">Esci</button>
                </div>
                <div id="client-content-area" class="glass-card p-6"></div>
            </div>
        </main>
    </div>

    <div id="modal-container" class="hidden"></div>
    <div id="toast" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, doc, updateDoc, onSnapshot, deleteDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAD3gr0W-dQ8WydozzVZV63uXegxhbYi0Y",
            authDomain: "logistica-ritiri-app-personale.firebaseapp.com",
            projectId: "logistica-ritiri-app-personale",
            storageBucket: "logistica-ritiri-app-personale.firebasestorage.app",
            messagingSenderId: "1082517021408",
            appId: "1:1082517021408:web:075f0aee13fdd2a6496685"
        };
        
        const WAREHOUSES = {
            'superadmin': 'Super Amministratore',
            '1q': 'Magazzino Principale',
            '2w': 'Deposito Secondario',
            '3e': 'Logistica Esterna'
        };

        let db, auth, pickupsCollection, functions;
        let app;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            functions = getFunctions(app, 'europe-west3');
        } catch (error) {
            console.error("Errore di configurazione Firebase:", error);
            showToast("Configurazione Firebase mancante o errata.", true);
        }

        let currentView = 'role-selection-view';
        let currentPickupId = null;
        let currentWarehouseId = null; 
        let adminUnsubscribe, clientUnsubscribe;
        let isSuperAdmin = false;

        onAuthStateChanged(auth, user => {
            if (!user) { signInAnonymously(auth).catch(e => console.error("Login anonimo fallito", e)); }
        });

        window.showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        };

        window.showToast = (message, isError = false) => {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = `toast show ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3500);
        };

        window.logout = async () => {
            if (adminUnsubscribe) adminUnsubscribe();
            if (clientUnsubscribe) clientUnsubscribe();
            currentPickupId = null;
            currentWarehouseId = null;
            isSuperAdmin = false;
            document.getElementById('client-code').value = '';
            document.getElementById('admin-password').value = '';
            
            await signOut(auth);
            await signInAnonymously(auth);

            showView('role-selection-view');
        }

        const showModal = (title, content, onConfirm, confirmText = 'Conferma', confirmClass = 'btn-primary') => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop"></div><div class="modal glass-card p-6 text-emotiva-text-dark-bg"><h3 class="text-xl font-bold mb-4">${title}</h3><div id="modal-content">${content}</div><div class="flex justify-end gap-3 mt-6"><button id="modal-cancel" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Annulla</button><button id="modal-confirm" class="${confirmClass} font-bold py-2 px-4 rounded-lg">${confirmText}</button></div></div>`;
            modalContainer.classList.remove('hidden');
            document.getElementById('modal-cancel').onclick = () => modalContainer.classList.add('hidden');
            document.getElementById('modal-confirm').onclick = onConfirm;
        };
        const hideModal = () => document.getElementById('modal-container').classList.add('hidden');

        window.loginAdmin = async () => {
            const password = document.getElementById('admin-password').value;
            const loginButton = document.getElementById('admin-login-button');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Accesso...';

            try {
                const authenticateWarehouse = httpsCallable(functions, 'authenticateWarehouse');
                const result = await authenticateWarehouse({ password: password });
                
                if (result.data.error) {
                    throw new Error(result.data.error);
                }

                const token = result.data.token;
                await signInWithCustomToken(auth, token);
                
                currentWarehouseId = result.data.warehouseId;
                isSuperAdmin = currentWarehouseId === 'superadmin';
                document.getElementById('warehouse-name').innerText = result.data.warehouseName;

                if (isSuperAdmin) {
                    pickupsCollection = collectionGroup(db, 'pickups');
                    document.getElementById('add-pickup-container').style.display = 'none';
                } else {
                    pickupsCollection = collection(db, 'warehouses', currentWarehouseId, 'pickups');
                    document.getElementById('add-pickup-container').style.display = 'block';
                }
                showView('admin-dashboard-view');
                listenForPickupsAdmin();

            } catch (error) {
                console.error("Authentication failed:", error);
                showToast(error.message || "Password non valida.", true);
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Accedi';
            }
        };
        
        const palletCountInput = document.getElementById('pallet-count');
        palletCountInput.addEventListener('input', () => {
            const count = parseInt(palletCountInput.value) || 0;
            const container = document.getElementById('packages-container');
            container.innerHTML = '';

            if (count > 0 && count < 20) {
                for (let i = 1; i <= count; i++) {
                    const packageDiv = document.createElement('div');
                    packageDiv.className = 'md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 border-t border-gray-700 pt-4';
                    
                    const label = document.createElement('label');
                    label.className = 'font-semibold md:col-span-2 text-gray-300';
                    label.textContent = `Dettagli Collo/Bancale ${i}`;
                    packageDiv.appendChild(label);

                    const dimensionInput = document.createElement('input');
                    dimensionInput.type = 'text';
                    dimensionInput.id = `dimension-${i}`;
                    dimensionInput.placeholder = `Dimensioni (es. 120x80x100 cm)`;
                    dimensionInput.className = 'p-3 rounded-lg transition';
                    packageDiv.appendChild(dimensionInput);
                    
                    const weightInput = document.createElement('input');
                    weightInput.type = 'text';
                    weightInput.id = `weight-${i}`;
                    weightInput.placeholder = `Peso (es. 50kg)`;
                    weightInput.className = 'p-3 rounded-lg transition';
                    packageDiv.appendChild(weightInput);
                    
                    container.appendChild(packageDiv);
                }
            }
        });

        document.getElementById('add-pickup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const palletCountValue = document.getElementById('pallet-count').value;
            const clientNameValue = document.getElementById('client-name').value;
            const clientStandValue = document.getElementById('client-stand').value;
            const pickupAddressValue = document.getElementById('pickup-address').value;

            if (!clientNameValue.trim() || !pickupAddressValue.trim() || !clientStandValue.trim()) {
                showToast("Fiera, Cliente/Stand e Indirizzo sono obbligatori.", true); return;
            }
            if (!palletCountValue || isNaN(parseInt(palletCountValue)) || parseInt(palletCountValue) < 1) {
                showToast("Il campo 'Numero Bancali/Colli' è obbligatorio.", true); return;
            }
            
            const packages = [];
            const count = parseInt(palletCountValue);
            for (let i = 1; i <= count; i++) {
                const dimensionInput = document.getElementById(`dimension-${i}`);
                const weightInput = document.getElementById(`weight-${i}`);
                packages.push({
                    dimension: dimensionInput ? dimensionInput.value : 'N/D',
                    weight: weightInput ? weightInput.value : 'N/D'
                });
            }

            const initialDates = [
                document.getElementById('initial-date-1').value,
                document.getElementById('initial-date-2').value,
                document.getElementById('initial-date-3').value,
            ].filter(Boolean).map(d => new Date(d));
            
            const initialStatus = initialDates.length > 0 ? 'Date Proposte' : 'Da Ritirare';
            const uniqueCode = `RIT-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;

            try {
                await addDoc(collection(db, 'warehouses', currentWarehouseId, 'pickups'), {
                    warehouseId: currentWarehouseId,
                    clientName: clientNameValue, // Fiera
                    clientStand: clientStandValue, // Stand
                    clientNotificationEmail: "", // Inizialmente vuoto
                    palletCount: parseInt(palletCountValue),
                    palletDesc: document.getElementById('pallet-desc').value,
                    packages: packages,
                    pickupAddress: pickupAddressValue,
                    pickupContactName: document.getElementById('pickup-contact-name').value,
                    pickupContactPhone: document.getElementById('pickup-contact-phone').value,
                    uniqueCode,
                    status: initialStatus,
                    pickupDateTime: null,
                    clientProposedDate: null, 
                    proposedDates: initialDates,
                    clientNotes: '',
                    createdAt: new Date(),
                });
                showToast(`Ritiro aggiunto! Codice: ${uniqueCode}`);
                e.target.reset();
                document.getElementById('packages-container').innerHTML = '';
            } catch(error) {
                console.error("Errore aggiunta Firestore:", error);
                showToast("Errore durante l'aggiunta.", true);
            }
        });

        function listenForPickupsAdmin() {
            if (adminUnsubscribe) adminUnsubscribe();
            adminUnsubscribe = onSnapshot(query(pickupsCollection), (snapshot) => {
                const ongoingList = document.getElementById('pickups-list-ongoing');
                const completedList = document.getElementById('pickups-list-completed');
                ongoingList.innerHTML = '';
                completedList.innerHTML = '';

                const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), path: doc.ref.path }));

                const statusOrder = { 'Richiesta Inviata': 1, 'Date Proposte': 2, 'Programmato': 3, 'Da Ritirare': 4, 'Completato': 5 };
                docs.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

                let ongoingCount = 0;
                let completedCount = 0;

                docs.forEach(p => {
                    const card = createAdminPickupCard(p);
                    if (p.status === 'Completato') {
                        completedList.appendChild(card);
                        completedCount++;
                    } else {
                        ongoingList.appendChild(card);
                        ongoingCount++;
                    }
                });

                if (ongoingCount === 0) {
                    ongoingList.innerHTML = '<p class="text-gray-400 p-4">Nessun ritiro in corso.</p>';
                }
                if (completedCount === 0) {
                    completedList.innerHTML = '<p class="text-gray-400 p-4">Nessun ritiro completato.</p>';
                }
            });
        }

        const STATUS_CONFIG = {
            'Da Ritirare': { text: 'Da Ritirare', color: 'bg-gray-700 text-gray-200', border: 'border-gray-500' },
            'Richiesta Inviata': { text: 'Richiesta Cliente', color: 'bg-orange-900 bg-opacity-50 text-orange-300', border: 'border-orange-500' },
            'Date Proposte': { text: 'In Attesa Cliente', color: 'bg-yellow-900 bg-opacity-50 text-yellow-300', border: 'border-yellow-500' },
            'Programmato': { text: 'Programmato', color: 'bg-blue-900 bg-opacity-50 text-blue-300', border: 'border-blue-500' },
            'Completato': { text: 'Completato', color: 'bg-green-900 bg-opacity-50 text-green-300', border: 'border-green-500' }
        };

        function createAdminPickupCard(pickup) {
            const card = document.createElement('div');
            card.className = 'glass-card p-4 border-l-4';
            const config = STATUS_CONFIG[pickup.status] || STATUS_CONFIG['Da Ritirare'];
            card.style.borderColor = config.border.replace('border-', '');
            const pickupDate = pickup.pickupDateTime ? new Date(pickup.pickupDateTime.seconds * 1000).toLocaleString('it-IT') : 'Da definire';
            const isRescheduleRequest = pickup.status === 'Richiesta Inviata' && pickup.clientNotes && pickup.clientNotes.startsWith('RICHIESTA DI RIPROGRAMMAZIONE');

            let clientProposalHTML = '';
            if (pickup.status === 'Richiesta Inviata' && pickup.clientProposedDate) {
                const proposedDate = new Date(pickup.clientProposedDate.seconds * 1000).toLocaleString('it-IT');
                clientProposalHTML = `<div class="mt-2 p-2 bg-orange-900 bg-opacity-30 rounded-lg"><p class="font-semibold text-orange-300">Proposta cliente: ${proposedDate}</p></div>`;
            }
            
            let actionButtonsHTML = '';
            if (pickup.status === 'Richiesta Inviata') {
                actionButtonsHTML = `<div class="flex gap-2">
                    <button onclick="window.proposeDates('${pickup.path}')" class="bg-yellow-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 transition">Controproponi</button>
                    <button onclick="window.confirmClientDate('${pickup.path}')" class="btn-secondary text-sm font-bold py-2 px-3 rounded-lg">Conferma Data Cliente</button>
                </div>`;
            } else if (pickup.status === 'Programmato') {
                 actionButtonsHTML = `<button onclick="window.markAsCompleted('${pickup.path}')" class="btn-secondary font-bold py-2 px-4 rounded-lg"><i class="fas fa-check mr-2"></i>Segna Completato</button>`;
            }
            
            const packagesText = Array.isArray(pickup.packages) && pickup.packages.length > 0
                ? pickup.packages.map((pkg, i) => `Collo ${i+1}: ${pkg.dimension || 'N/D'} - ${pkg.weight || 'N/D'}`).join('<br>')
                : 'N/D';
            
            let superAdminEmailHTML = '';
            if (isSuperAdmin) {
                superAdminEmailHTML = `
                <div class="mt-3 pt-3 border-t border-gray-700">
                    <label for="email-input-${pickup.id}" class="text-sm font-medium text-gray-300">Email Notifiche Cliente:</label>
                    <div class="flex gap-2 mt-1">
                        <input type="email" id="email-input-${pickup.id}" value="${pickup.clientNotificationEmail || ''}" class="w-full p-2 rounded-lg transition" placeholder="Aggiungi email cliente...">
                        <button onclick="window.updateClientEmail('${pickup.path}', '${pickup.id}')" class="btn-primary px-4 rounded-lg text-sm">Salva</button>
                    </div>
                </div>`;
            }

            const footerHTML = `
                <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                    <div>${actionButtonsHTML}</div>
                    <button onclick="window.deletePickup('${pickup.path}')" class="text-gray-400 hover:text-red-500 transition-colors duration-300 w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center">
                        <i class="fas fa-trash-alt fa-sm"></i>
                    </button>
                </div>
            `;

            card.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between">
                    <div class="pr-8">
                        <p class="font-bold text-lg flex items-center">${pickup.clientName} / ${pickup.clientStand} ${isRescheduleRequest ? '<span class="ml-3 text-sm font-semibold text-red-300 bg-red-900 bg-opacity-50 px-2 py-1 rounded-full">DA RIPROGRAMMARE</span>' : ''}</p>
                        <p class="text-sm text-gray-400">${pickup.palletCount} colli - Codice: <span class="font-semibold">${pickup.uniqueCode}</span></p>
                        ${clientProposalHTML}
                        <p class="text-sm text-gray-500 italic mt-1">${pickup.clientNotes || ''}</p>
                    </div>
                    <div class="mt-4 md:mt-0 text-left md:text-right flex-shrink-0">
                        <p class="font-semibold">Ritiro: <span class="font-normal">${pickupDate}</span></p>
                        <p class="font-semibold mt-1"><span class="px-2 py-1 rounded-full text-xs ${config.color}">${config.text}</span></p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 text-sm">
                    <div class="md:col-span-2"><i class="fas fa-box-open fa-fw text-gray-400 mr-2"></i><strong>Dettagli Colli:</strong><br><div class="pl-6">${packagesText}</div></div>
                    <div class="md:col-span-2 mt-1"><i class="fas fa-at fa-fw text-gray-400 mr-2"></i><strong>Email Notifiche:</strong> ${pickup.clientNotificationEmail || 'N/D'}</div>
                    <div class="md:col-span-2 mt-1"><i class="fas fa-map-marker-alt fa-fw text-gray-400 mr-2"></i><strong>Indirizzo:</strong> ${pickup.pickupAddress || 'N/D'}</div>
                    <div class="md:col-span-2 mt-1"><i class="fas fa-user-tag fa-fw text-gray-400 mr-2"></i><strong>Referente:</strong> ${pickup.pickupContactName || 'N/D'} (${pickup.pickupContactPhone || 'N/D'})</div>
                </div>
                ${superAdminEmailHTML}
                ${footerHTML}
            `;
            return card;
        }
        
        window.updateClientEmail = async (docPath, pickupId) => {
            const emailInput = document.getElementById(`email-input-${pickupId}`);
            const newEmail = emailInput.value.trim();
            if (!newEmail) {
                showToast("Inserisci un indirizzo email valido.", true);
                return;
            }
            try {
                await updateDoc(doc(db, docPath), { clientNotificationEmail: newEmail });
                showToast("Email del cliente aggiornata!");
            } catch (e) {
                console.error("Errore aggiornamento email:", e);
                showToast("Errore durante l'aggiornamento.", true);
            }
        };
        
        window.confirmClientDate = async (docPath) => {
            const docRef = doc(db, docPath);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().clientProposedDate) {
                    await updateDoc(docRef, {
                        pickupDateTime: docSnap.data().clientProposedDate,
                        status: 'Programmato',
                        clientProposedDate: null, 
                        proposedDates: []
                    });
                    showToast("Data del cliente confermata!");
                } else { showToast("Nessuna data proposta dal cliente.", true); }
            } catch (e) { console.error(e); showToast("Errore durante la conferma.", true); }
        };

        window.proposeDates = (docPath) => {
            const content = `<p class="text-sm mb-4">Inserisci fino a 3 date.</p>
                <input type="datetime-local" id="date1" class="w-full p-2 border rounded mb-2"><input type="datetime-local" id="date2" class="w-full p-2 border rounded mb-2"><input type="datetime-local" id="date3" class="w-full p-2 border rounded">`;
            showModal('Proponi Date Alternative', content, async () => {
                const dates = [document.getElementById('date1').value, document.getElementById('date2').value, document.getElementById('date3').value].filter(Boolean).map(d => new Date(d));
                if (dates.length === 0) { showToast('Inserisci almeno una data.', true); return; }
                
                try {
                    await updateDoc(doc(db, docPath), { proposedDates: dates, status: 'Date Proposte', clientProposedDate: null });
                    showToast('Controproposta inviata!');
                    hideModal();
                } catch(e) { console.error(e); showToast('Errore nel salvataggio.', true); }
            }, 'Invia Proposte');
        };

        window.markAsCompleted = async (docPath) => {
            showModal('Conferma Completamento', '<p>Sei sicuro di voler segnare questo ritiro come completato?</p>', async () => {
                try {
                    await updateDoc(doc(db, docPath), { status: 'Completato' });
                    showToast('Ritiro completato!');
                    hideModal();
                } catch(e) { console.error(e); showToast("Errore durante l'aggiornamento.", true); }
            }, 'Conferma', 'btn-secondary');
        }

        window.deletePickup = (docPath) => {
            showModal(
                'Conferma Eliminazione',
                '<p>Sei sicuro di voler eliminare definitivamente questo ritiro? L\'azione non è reversibile.</p>',
                async () => {
                    try {
                        await deleteDoc(doc(db, docPath));
                        showToast('Ritiro eliminato con successo!');
                        hideModal();
                    } catch (e) {
                        console.error("Errore durante l'eliminazione:", e);
                        showToast("Errore durante l'eliminazione.", true);
                    }
                },
                'Elimina',
                'bg-red-600 text-white hover:bg-red-700'
            );
        };

        window.showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // --- CLIENT LOGIC ---
        window.loginClient = async () => {
            const code = document.getElementById('client-code').value.trim().toUpperCase();
            if (!code) return showToast("Inserisci un codice.", true);
            
            const q = query(collectionGroup(db, 'pickups'), where("uniqueCode", "==", code));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) return showToast("Codice non valido.", true);
            
            const foundPickup = snapshot.docs[0];
            const docPath = foundPickup.ref.path;
            currentPickupId = foundPickup.id;

            if (clientUnsubscribe) clientUnsubscribe();
            clientUnsubscribe = onSnapshot(doc(db, docPath), (doc) => {
                if(doc.exists()) {
                    renderClientView(doc.data());
                } else { logout(); }
            });
            showView('client-view');
        };

        function renderClientView(data) {
            const container = document.getElementById('client-content-area');
            const title = document.getElementById('client-view-title');
            
            const packagesText = Array.isArray(data.packages) && data.packages.length > 0 
                ? data.packages.map((pkg, i) => `<p class="text-sm"><span class="font-medium text-gray-300">Collo ${i+1}:</span> ${pkg.dimension || 'N/D'} - ${pkg.weight || 'N/D'}</p>`).join('')
                : `N/D`;

            const baseDetails = `
                <div class="mb-4 pb-4 border-b border-gray-700">
                    <h4 class="text-lg font-semibold mb-2 text-white">Dati Materiale</h4>
                    <p class="text-sm"><span class="font-medium text-gray-300">Fiera:</span> ${data.clientName || 'N/D'}</p>
                    <p class="text-sm"><span class="font-medium text-gray-300">Stand:</span> ${data.clientStand || 'N/D'}</p>
                    <p class="text-sm"><span class="font-medium text-gray-300">N° Colli:</span> ${data.palletCount || 'N/D'}</p>
                    <p class="text-sm"><span class="font-medium text-gray-300">Descrizione:</span> ${data.palletDesc || 'N/A'}</p>
                    <div class="mt-2">${packagesText}</div>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-700">
                    <h4 class="text-lg font-semibold mb-2 text-white">Dettagli Ritiro</h4>
                    <p class="text-sm"><span class="font-medium text-gray-300">Indirizzo:</span> ${data.pickupAddress || 'N/D'}</p>
                    <p class="text-sm"><span class="font-medium text-gray-300">Referente in loco:</span> ${data.pickupContactName || 'N/D'} (${data.pickupContactPhone || 'N/D'})</p>
                </div>`;
            
            switch(data.status) {
                case 'Da Ritirare':
                    title.innerText = 'Proponi una Data di Ritiro';
                    container.innerHTML = `${baseDetails}
                        <p class="mb-2 font-semibold">Il tuo materiale è pronto. Proponi una data e un'ora per il ritiro:</p>
                        <input type="datetime-local" id="client-proposed-date" class="w-full p-2 border rounded mb-2">
                        <textarea id="client-notes" class="w-full p-2 border rounded mb-4" placeholder="Aggiungi eventuali note (opzionale)">${data.clientNotes || ''}</textarea>
                        <button onclick="window.requestPickup()" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg">Invia Proposta di Ritiro</button>`;
                    break;
                case 'Richiesta Inviata':
                    title.innerText = 'Proposta Inviata';
                    container.innerHTML = `${baseDetails}<div class="p-4 bg-orange-900 bg-opacity-50 text-orange-300 rounded-lg text-center"><i class="fas fa-clock fa-2x mb-2"></i><p class="font-bold">Proposta inviata con successo!</p><p class="text-sm">Attendi la conferma o una controproposta.</p></div>`;
                    break;
                case 'Date Proposte':
                    title.innerText = 'Proposta di Ritiro Ricevuta';
                    let proposalsHTML = data.proposedDates.map(d => { const date = new Date(d.seconds * 1000); return `<label class="block border border-gray-600 rounded-lg p-3 mb-2 hover:bg-gray-700 cursor-pointer"><input type="radio" name="date-proposal" value="${date.toISOString()}" class="mr-3"><span class="font-semibold">${date.toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'})}</span> alle <span class="font-semibold">${date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</span></label>`; }).join('');
                    container.innerHTML = `${baseDetails}
                        <p class="mb-4 font-semibold text-white">Il coordinatore ha proposto le seguenti date. Scegli quella che preferisci:</p>
                        <div class="mb-4">${proposalsHTML}</div>
                        <button onclick="window.confirmSlot()" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg">Conferma la data selezionata</button>
                        <button onclick="window.rejectAndRepropose()" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition mt-2">Nessuna di queste date va bene</button>`;
                    break;
                case 'Programmato':
                case 'Completato':
                    title.innerText = `Ritiro ${data.status}`;
                    const pickupDate = new Date(data.pickupDateTime.seconds * 1000);
                    let actionsHTML = data.status !== 'Completato' ? `<div class="mt-6 pt-6 border-t border-gray-700"><h4 class="font-semibold mb-2">Imprevisti?</h4><button onclick="window.requestReschedule()" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Richiedi Modifica Ritiro</button></div>` : '';
                    container.innerHTML = `${baseDetails}
                        <div class="p-4 ${data.status === 'Completato' ? 'bg-green-900 bg-opacity-50 text-green-300' : 'bg-blue-900 bg-opacity-50 text-blue-300'} rounded-lg text-center"><i class="fas ${data.status === 'Completato' ? 'fa-check-circle' : 'fa-calendar-check'} fa-2x mb-2"></i><p class="font-bold">Ritiro ${data.status === 'Completato' ? 'Effettuato' : 'Confermato'}</p><p>Il <strong>${pickupDate.toLocaleDateString('it-IT')}</strong> alle <strong>${pickupDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})}</strong></p></div>
                        ${actionsHTML}`;
                    break;
            }
        }
        
        window.requestPickup = async () => {
            const proposedDateValue = document.getElementById('client-proposed-date').value;
            if (!proposedDateValue) { return showToast("Per favore, proponi una data e un'ora.", true); }
            try {
                await updateDoc(doc(db, 'warehouses', WAREHOUSES[currentWarehouseId], 'pickups', currentPickupId), { 
                    status: 'Richiesta Inviata', 
                    clientNotes: document.getElementById('client-notes').value,
                    clientProposedDate: new Date(proposedDateValue)
                });
                showToast('Proposta di ritiro inviata!');
            } catch (e) { console.error(e); showToast('Errore. Riprova.', true); }
        };

        window.confirmSlot = async () => {
            const selectedDateValue = document.querySelector('input[name="date-proposal"]:checked');
            if (!selectedDateValue) return showToast('Per favore, seleziona una data.', true);
            try {
                await updateDoc(doc(db, 'warehouses', WAREHOUSES[currentWarehouseId], 'pickups', currentPickupId), { 
                    status: 'Programmato', 
                    pickupDateTime: new Date(selectedDateValue.value),
                    proposedDates: [], 
                    clientProposedDate: null
                });
                showToast('Appuntamento confermato!');
            } catch (e) { console.error(e); showToast('Errore. Riprova.', true); }
        };
        
        window.requestReschedule = () => {
            const content = `<p>Vuoi richiedere una modifica? L'appuntamento verrà annullato e potrai proporre una nuova data.</p><textarea id="reschedule-reason" class="w-full p-2 border rounded mt-4" placeholder="Motivo (opzionale)"></textarea>`;
            showModal('Richiedi Modifica Ritiro', content, async () => {
                const reason = document.getElementById('reschedule-reason').value;
                const note = `RICHIESTA DI RIPROGRAMMAZIONE. ${reason ? 'Motivo: ' + reason : ''}`;
                try {
                    await updateDoc(doc(db, 'warehouses', WAREHOUSES[currentWarehouseId], 'pickups', currentPickupId), { 
                        status: 'Da Ritirare', 
                        pickupDateTime: null, 
                        proposedDates: [], 
                        clientProposedDate: null,
                        clientNotes: note 
                    });
                    showToast('Richiesta inviata. Proponi una nuova data.');
                    hideModal();
                } catch(e) { console.error(e); showToast('Errore. Riprova.', true); }
            }, 'Conferma Richiesta');
        };

        window.rejectAndRepropose = () => {
            const content = `
                <p class="mb-2">Proponi una nuova data e ora per il ritiro:</p>
                <input type="datetime-local" id="client-reproposed-date" class="w-full p-2 border rounded mb-2">
                <textarea id="reproposal-notes" class="w-full p-2 border rounded" placeholder="Note (opzionale)"></textarea>
            `;
            showModal('Proponi una Nuova Data', content, async () => {
                const newProposedDate = document.getElementById('client-reproposed-date').value;
                if (!newProposedDate) { return showToast("Inserisci una nuova data.", true); }
                
                try {
                    await updateDoc(doc(db, 'warehouses', WAREHOUSES[currentWarehouseId], 'pickups', currentPickupId), {
                        status: 'Richiesta Inviata',
                        clientNotes: 'Controproposta del cliente: ' + document.getElementById('reproposal-notes').value,
                        clientProposedDate: new Date(newProposedDate),
                        proposedDates: [],
                    });
                    showToast('Nuova proposta inviata!');
                    hideModal();
                } catch(e) { console.error(e); showToast("Errore. Riprova.", true); }
            }, 'Invia Nuova Proposta');
        };
    </script>
</body>
</html>
