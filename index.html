<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Ritiri Emotiva</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts: Poppins -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
:root {
--emotiva-purple: #9c6da5;
--emotiva-purple-dark: #8a5f93;
--emotiva-green: #5cb85c;
--emotiva-green-dark: #4a934a;
--emotiva-text-dark-bg: #EAEAEA;
--emotiva-text-light-bg: #333;
}
.text-emotiva-purple {
color: var(--emotiva-purple);
}
/* Ensure html and body expand to fit content within the iframe */
html, body {
height: auto; /* Allow height to be determined by content */
min-height: 100%; /* Ensure it takes at least 100% of viewport if content is small */
font-family: 'Poppins', sans-serif;
background-color: transparent;
color: var(--emotiva-text-dark-bg);
margin-bottom: 4rem; /* Added margin-bottom to the body for extra space at the end */
}
.btn-primary {
background-color: var(--emotiva-purple); color: white; transition: all 0.3s ease;
box-shadow: 0 4px 14px 0 rgba(156, 109, 165, 0.39);
}
.btn-primary:hover {
background-color: var(--emotiva-purple-dark); transform: translateY(-2px);
box-shadow: 0 6px 20px 0 rgba(156, 109, 165, 0.5);
}
.btn-secondary {
background-color: var(--emotiva-green); color: white; transition: all 0.3s ease;
box-shadow: 0 4px 14px 0 rgba(92, 184, 92, 0.39);
}
.btn-secondary:hover {
background-color: var(--emotiva-green-dark); transform: translateY(-2px);
box-shadow: 0 6px 20px 0 rgba(92, 184, 92, 0.5);
}
.view { display: none; }
.view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.toast {
visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333;
color: #fff; text-align: center; border-radius: 8px; padding: 16px;
position: fixed; z-index: 100; left: 50%; bottom: 30px; opacity: 0;
transition: all 0.5s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.toast.show { visibility: visible; opacity: 1; bottom: 50px; }
.modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 50; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; }
.glass-card {
background: rgba(30, 30, 40, 0.6);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
border-radius: 1rem;
border: 1px solid rgba(255, 255, 255, 0.1);
}
input, textarea {
background-color: rgba(255, 255, 255, 0.05) !important;
border-color: rgba(255, 255, 255, 0.2) !important;
color: var(--emotiva-text-dark-bg) !important;
}
input::placeholder, textarea::placeholder { color: #a0aec0 !important; }
input:focus, textarea:focus { border-color: var(--emotiva-purple) !important; box-shadow: 0 0 0 2px rgba(156, 109, 165, 0.5) !important; }
.tab-button.active { border-color: var(--emotiva-purple); color: var(--emotiva-purple); }
/* --- Flatpickr Overrides for Dark Theme and Styling --- */
.flatpickr-calendar {
background: #2d3748 !important; /* Tailwind gray-800 */
border: 1px solid rgba(255, 255, 255, 0.1) !important;
border-radius: 0.5rem !important;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
}
.flatpickr-day, .flatpickr-weekday {
color: var(--emotiva-text-dark-bg) !important;
}
.flatpickr-day.selected, .flatpickr-day.selected:hover, .flatpickr-day.today.selected {
background: var(--emotiva-purple) !important;
border-color: var(--emotiva-purple) !important;
color: white !important;
}
.flatpickr-day.today {
border-color: var(--emotiva-purple) !important;
}
.flatpickr-day:hover {
background: rgba(156, 109, 165, 0.2) !important;
}
.flatpickr-current-month, .flatpickr-current-month .flatpickr-month, .flatpickr-current-month .cur-year {
color: var(--emotiva-text-dark-bg) !important;
}
.flatpickr-time input, .flatpickr-time .flatpickr-am-pm {
color: var(--emotiva-text-dark-bg) !important;
}
</style>
</head>
<body class="antialiased">

<div id="main-content-wrapper" class="w-full mx-auto px-4 pb-16">
<header class="text-center mb-8 pt-8">
<img src="logo.png" alt="Logo Emotiva" class="mx-auto mb-4 h-12" onerror="this.style.display='none'">
<h1 class="text-3xl md:text-4xl font-bold text-white">Piattaforma Ritiri</h1>
</header>

<main id="app-container">
<!-- Role Selection View -->
<div id="role-selection-view" class="view active text-center glass-card p-8">
<h2 class="text-2xl font-semibold mb-6 text-white">Seleziona il tuo ruolo</h2>
<div class="flex flex-col md:flex-row gap-4 justify-center">
<button onclick="showView('admin-login-view')" class="btn-primary font-bold py-3 px-6 rounded-lg"><i class="fas fa-user-shield mr-2"></i> Coordinatore / Magazzino</button>
<button onclick="showView('client-login-view')" class="btn-secondary font-bold py-3 px-6 rounded-lg"><i class="fas fa-user mr-2"></i> Cliente</button>
</div>
</div>

<!-- Admin Login View -->
<div id="admin-login-view" class="view glass-card p-8">
<button onclick="showView('role-selection-view')" class="text-emotiva-purple hover:underline mb-4"><i class="fas fa-arrow-left mr-2"></i>Torna indietro</button>
<h2 class="text-2xl font-semibold mb-4 text-center text-white">Accesso Area Riservata</h2>
<input type="password" id="admin-password" placeholder="Inserisci password" class="w-full p-3 rounded-lg mb-4 transition">
<button id="admin-login-button" onclick="loginAdmin()" class="w-full btn-primary font-bold py-3 px-6 rounded-lg">Accedi</button>
</div>

<!-- Client Login View -->
<div id="client-login-view" class="view glass-card p-8">
<button onclick="showView('role-selection-view')" class="text-emotiva-purple hover:underline mb-4"><i class="fas fa-arrow-left mr-2"></i>Torna indietro</button>
<h2 class="text-2xl font-semibold mb-4 text-center text-white">Accesso Cliente</h2>
<p class="text-center text-gray-400 mb-4">Inserisci il codice univoco per gestire il tuo ritiro.</p>
<input type="text" id="client-code" placeholder="Il tuo codice di ritiro" class="w-full p-3 rounded-lg mb-4 transition">
<button id="client-login-button" onclick="loginClient()" class="w-full btn-secondary font-bold py-3 px-6 rounded-lg">Verifica Codice</button>
</div>

<!-- Admin Dashboard View -->
<div id="admin-dashboard-view" class="view">
<div class="flex justify-between items-center mb-6">
<div>
<h2 class="text-2xl font-semibold text-white">Pannello di Controllo</h2>
<p id="warehouse-name" class="text-lg" style="color: var(--emotiva-purple);"></p>
</div>
<button onclick="logout()" class="text-red-400 hover:text-red-500 hover:underline">Esci</button>
</div>
<div id="add-pickup-container" class="glass-card p-6 mb-8">
<h3 class="text-xl font-semibold mb-4 text-white">Aggiungi Materiale Cliente</h3>
<form id="add-pickup-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
<h4 class="md:col-span-2 text-lg font-medium text-gray-300 border-b border-gray-700 pb-2">Cliente</h4>
<input type="text" id="client-name" placeholder="Fiera" class="p-3 rounded-lg transition" required>
<input type="text" id="client-stand" placeholder="Cliente/Stand" class="p-3 rounded-lg transition" required>
<h4 class="md:col-span-2 text-lg font-medium text-gray-300 mt-4 border-b border-gray-700 pb-2">Dati Spedizione</h4>
<input type="number" id="pallet-count" placeholder="Numero Bancali/Colli" class="p-3 rounded-lg transition" required min="1">
<div id="packages-container" class="md:col-span-2 grid grid-cols-1 gap-y-4"></div>
<textarea id="pallet-desc" placeholder="Descrizione contenuto" class="p-3 rounded-lg md:col-span-2 transition" rows="2"></textarea>
<h4 class="md:col-span-2 text-lg font-medium text-gray-300 mt-4 border-b border-gray-700 pb-2">Dati per il Corriere</h4>
<textarea id="pickup-address" placeholder="Indirizzo completo (Via, CAP, Città, Paese)" class="p-3 rounded-lg md:col-span-2 transition" rows="3" required></textarea>
<input type="text" id="pickup-contact-name" placeholder="Nome referente magazzino" class="p-3 rounded-lg transition">
<input type="tel" id="pickup-contact-phone" placeholder="Telefono referente" class="p-3 rounded-lg transition">
<h4 class="md:col-span-2 text-lg font-medium text-gray-300 mt-4 border-b border-gray-700 pb-2">Proponi Data e Ora di Ritiro</h4>
<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
<input type="text" id="pickup-date-input" placeholder="Seleziona Data" class="p-3 rounded-lg transition" readonly>
<div class="flex items-center">
<span class="text-sm text-gray-300 mr-2">Orario:</span>
<input type="text" id="pickup-time-input" placeholder="Seleziona Ora" class="w-full p-3 rounded-lg transition" readonly>
</div>
</div>
<button type="submit" class="md:col-span-2 w-full btn-primary font-bold py-3 px-6 rounded-lg mt-4">Aggiungi e Genera Codice</button>
</form>
</div>
<div>
<div class="border-b border-gray-700">
<nav class="-mb-px flex space-x-8" aria-label="Tabs">
<button id="tab-ongoing" onclick="showTab('ongoing')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active">In corso</button>
<button id="tab-completed" onclick="showTab('completed')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Completati</button>
</nav>
</div>
<div id="tab-content-ongoing" class="tab-content active"><div id="pickups-list-ongoing" class="space-y-4 mt-6"></div></div>
<div id="tab-content-completed" class="tab-content" style="display: none;"><div id="pickups-list-completed" class="space-y-4 mt-6"></div></div>
</div>
</div>

<!-- Client View -->
<div id="client-view" class="view">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-semibold text-white" id="client-view-title">Dettagli Ritiro</h2>
<button onclick="logout()" class="text-red-400 hover:text-red-500 hover:underline">Esci</button>
</div>
<div id="client-content-area" class="glass-card p-6"></div>
</div>
</main>
</div>

<div id="modal-container" class="hidden"></div>
<div id="toast" class="toast"></div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script> <!-- Italian locale -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, doc, updateDoc, onSnapshot, deleteDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

// NOTA PER LO SVILUPPATORE: Se ricevi un errore "internal" durante il login admin,
// assicurati che nel tuo progetto Google Cloud:
// 1. L'API "Identity Toolkit API" sia abilitata.
// 2. Il Service Account usato dalle Cloud Functions abbia il ruolo "Service Account Token Creator".
const firebaseConfig = {
    apiKey: "AIzaSyAD3gr0W-dQ8WydozzVZV63uXegxhbYi0Y",
    authDomain: "logistica-ritiri-app-personale.firebaseapp.com",
    projectId: "logistica-ritiri-app-personale",
    storageBucket: "logistica-ritiri-app-personale.appspot.com",
    messagingSenderId: "1082517021408",
    appId: "1:1082517021408:web:075f0aee13fdd2a6496685"
};

let db, auth, pickupsCollection, functions;
let app;
try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    functions = getFunctions(app, 'europe-west3');
} catch (error) {
    console.error("Errore di configurazione Firebase:", error);
    showToast("Errore di configurazione. Controlla la console per i dettagli.", true);
}

let currentView = 'role-selection-view';
let currentPickupDocPath = null;
let currentWarehouseId = null;
let adminUnsubscribe, clientUnsubscribe;
let isSuperAdmin = false;

onAuthStateChanged(auth, user => {
    if (!user) { signInAnonymously(auth).catch(e => console.error("Login anonimo fallito", e)); }
});

const sendHeight = () => {
    const height = document.getElementById('main-content-wrapper').scrollHeight;
    window.parent.postMessage({ type: 'resize', height: height }, '*');
};

window.showView = (viewId) => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');
    currentView = viewId;
    setTimeout(sendHeight, 100);
};

window.showToast = (message, isError = false) => {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `toast show ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3500);
};

window.logout = async () => {
    if (adminUnsubscribe) adminUnsubscribe();
    if (clientUnsubscribe) clientUnsubscribe();
    currentPickupDocPath = null;
    currentWarehouseId = null;
    isSuperAdmin = false;
    document.getElementById('client-code').value = '';
    document.getElementById('admin-password').value = '';
    await signOut(auth);
    await signInAnonymously(auth);
    showView('role-selection-view');
}

const showModal = (title, content, onConfirm, confirmText = 'Conferma', confirmClass = 'btn-primary') => {
    const modalContainer = document.getElementById('modal-container');
    modalContainer.innerHTML = `<div class="modal-backdrop"></div><div class="modal glass-card p-6 text-emotiva-text-dark-bg"><h3 class="text-xl font-bold mb-4">${title}</h3><div id="modal-content">${content}</div><div class="flex justify-end gap-3 mt-6"><button id="modal-cancel" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Annulla</button><button id="modal-confirm" class="${confirmClass} font-bold py-2 px-4 rounded-lg">${confirmText}</button></div></div>`;
    modalContainer.classList.remove('hidden');
    document.getElementById('modal-cancel').onclick = () => modalContainer.classList.add('hidden');
    document.getElementById('modal-confirm').onclick = onConfirm;
};
const hideModal = () => document.getElementById('modal-container').classList.add('hidden');

window.loginAdmin = async () => {
    const password = document.getElementById('admin-password').value;
    const loginButton = document.getElementById('admin-login-button');
    loginButton.disabled = true;
    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Accesso...';

    try {
        const authenticateWarehouse = httpsCallable(functions, 'authenticateWarehouse');
        const result = await authenticateWarehouse({ password: password });
        
        const token = result.data.token;
        const userCredential = await signInWithCustomToken(auth, token);
        const idTokenResult = await userCredential.user.getIdTokenResult(true);

        isSuperAdmin = idTokenResult.claims.isSuperAdmin === true;
        currentWarehouseId = result.data.warehouseId;
        document.getElementById('warehouse-name').innerText = result.data.warehouseName;
        
        const addPickupContainer = document.getElementById('add-pickup-container');
        if (isSuperAdmin) {
            pickupsCollection = collectionGroup(db, 'pickups');
            if(addPickupContainer) addPickupContainer.style.display = 'none';
        } else {
            pickupsCollection = collection(db, 'warehouses', currentWarehouseId, 'pickups');
            if(addPickupContainer) addPickupContainer.style.display = 'block';
        }
        showView('admin-dashboard-view');
        listenForPickupsAdmin();
        setTimeout(sendHeight, 200);

    } catch (error) {
        console.error("Authentication failed:", error);
        showToast(error.message || "Password non valida.", true);
    } finally {
        loginButton.disabled = false;
        loginButton.innerHTML = 'Accedi';
    }
};

const palletCountInput = document.getElementById('pallet-count');
palletCountInput.addEventListener('input', () => {
    const count = parseInt(palletCountInput.value) || 0;
    const container = document.getElementById('packages-container');
    container.innerHTML = '';

    if (count > 0 && count < 20) {
        for (let i = 1; i <= count; i++) {
            const packageDiv = document.createElement('div');
            packageDiv.className = 'md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 border-t border-gray-700 pt-4';
            const label = document.createElement('label');
            label.className = 'font-semibold md:col-span-2 text-gray-300';
            label.textContent = `Dettagli Collo/Bancale ${i}`;
            packageDiv.appendChild(label);

            const dimensionInput = document.createElement('input');
            dimensionInput.type = 'text';
            dimensionInput.id = `dimension-${i}`;
            dimensionInput.placeholder = `Dimensioni (es. 120x80x100 cm)`;
            dimensionInput.className = 'p-3 rounded-lg transition';
            packageDiv.appendChild(dimensionInput);
            const weightInput = document.createElement('input');
            weightInput.type = 'text';
            weightInput.id = `weight-${i}`;
            weightInput.placeholder = `Peso (es. 50kg)`;
            weightInput.className = 'p-3 rounded-lg transition';
            packageDiv.appendChild(weightInput);
            container.appendChild(packageDiv);
        }
    }
    sendHeight();
});

const pickupDateInput = document.getElementById('pickup-date-input');
const pickupTimeInput = document.getElementById('pickup-time-input');

flatpickr(pickupDateInput, {
    enableTime: false,
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "d/m/Y",
    minDate: "today",
    locale: flatpickr.l10ns.it
});

flatpickr(pickupTimeInput, {
    enableTime: true,
    noCalendar: true,
    dateFormat: "H:i",
    altInput: true,
    altFormat: "H:i",
    locale: flatpickr.l10ns.it
});

document.getElementById('add-pickup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const palletCountValue = document.getElementById('pallet-count').value;
    const clientNameValue = document.getElementById('client-name').value;
    const clientStandValue = document.getElementById('client-stand').value;
    const pickupAddressValue = document.getElementById('pickup-address').value;

    if (!clientNameValue.trim() || !pickupAddressValue.trim() || !clientStandValue.trim()) {
        showToast("Fiera, Cliente/Stand e Indirizzo sono obbligatori.", true); return;
    }
    if (!palletCountValue || isNaN(parseInt(palletCountValue)) || parseInt(palletCountValue) < 1) {
        showToast("Il campo 'Numero Bancali/Colli' è obbligatorio.", true); return;
    }
    const packages = [];
    const count = parseInt(palletCountValue);
    for (let i = 1; i <= count; i++) {
        const dimensionInput = document.getElementById(`dimension-${i}`);
        const weightInput = document.getElementById(`weight-${i}`);
        packages.push({
            dimension: dimensionInput ? dimensionInput.value : 'N/D',
            weight: weightInput ? weightInput.value : 'N/D'
        });
    }

    const dateStr = pickupDateInput.value;
    const timeStr = pickupTimeInput.value;

    let combinedPickupDateTime = null;
    let initialStatus = 'Da Ritirare';

    if (dateStr && timeStr) {
        const dateTimeCombinedStr = `${dateStr} ${timeStr}`;
        const parsedDate = flatpickr.parseDate(dateTimeCombinedStr, "Y-m-d H:i");

        if (parsedDate && parsedDate >= new Date()) {
            combinedPickupDateTime = parsedDate;
            initialStatus = 'Date Proposte';
        } else {
            showToast("La data e l'ora proposte devono essere valide e non nel passato.", true);
            return;
        }
    } else if (dateStr || timeStr) {
        showToast("Inserisci sia la data che l'ora proposte, oppure nessuna.", true);
        return;
    }
    const uniqueCode = `RIT-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;

    try {
        await addDoc(collection(db, 'warehouses', currentWarehouseId, 'pickups'), {
            warehouseId: currentWarehouseId,
            clientName: clientNameValue,
            clientStand: clientStandValue,
            clientNotificationEmail: "",
            palletCount: parseInt(palletCountValue),
            palletDesc: document.getElementById('pallet-desc').value,
            packages: packages,
            pickupAddress: pickupAddressValue,
            pickupContactName: document.getElementById('pickup-contact-name').value,
            pickupContactPhone: document.getElementById('pickup-contact-phone').value,
            uniqueCode,
            status: initialStatus,
            pickupDateTime: combinedPickupDateTime,
            clientProposedDate: null,
            proposedDates: combinedPickupDateTime ? [combinedPickupDateTime] : [],
            clientNotes: '',
            createdAt: new Date(),
        });
        showToast(`Ritiro aggiunto! Codice: ${uniqueCode}`);
        e.target.reset();
        document.getElementById('packages-container').innerHTML = '';
        pickupDateInput._flatpickr.clear();
        pickupTimeInput._flatpickr.clear();
        sendHeight();
    } catch(error) {
        console.error("Errore aggiunta Firestore:", error);
        showToast("Errore durante l'aggiunta.", true);
    }
});

function listenForPickupsAdmin() {
    if (adminUnsubscribe) adminUnsubscribe();
    adminUnsubscribe = onSnapshot(query(pickupsCollection), (snapshot) => {
        const ongoingList = document.getElementById('pickups-list-ongoing');
        const completedList = document.getElementById('pickups-list-completed');
        ongoingList.innerHTML = '';
        completedList.innerHTML = '';

        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), path: doc.ref.path }));

        const statusOrder = { 'Richiesta Inviata': 1, 'Date Proposte': 2, 'Programmato': 3, 'Da Ritirare': 4, 'Completato': 5 };
        docs.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

        let ongoingCount = 0;
        let completedCount = 0;

        docs.forEach(p => {
            const card = createAdminPickupCard(p);
            if (p.status === 'Completato') {
                completedList.appendChild(card);
                completedCount++;
            } else {
                ongoingList.appendChild(card);
                ongoingCount++;
            }
        });

        if (ongoingCount === 0) ongoingList.innerHTML = '<p class="text-gray-400 p-4">Nessun ritiro in corso.</p>';
        if (completedCount === 0) completedList.innerHTML = '<p class="text-gray-400 p-4">Nessun ritiro completato.</p>';
        sendHeight();
    });
}

const STATUS_CONFIG = {
    'Da Ritirare': { text: 'Da Ritirare', color: 'bg-gray-700 text-gray-200', border: 'border-gray-500' },
    'Richiesta Inviata': { text: 'Richiesta Cliente', color: 'bg-orange-900 bg-opacity-50 text-orange-300', border: 'border-orange-500' },
    'Date Proposte': { text: 'In Attesa Cliente', color: 'bg-yellow-900 bg-opacity-50 text-yellow-300', border: 'border-yellow-500' },
    'Programmato': { text: 'Programmato', color: 'bg-blue-900 bg-opacity-50 text-blue-300', border: 'border-blue-500' },
    'Completato': { text: 'Completato', color: 'bg-green-900 bg-opacity-50 text-green-300', border: 'border-green-500' }
};

function createAdminPickupCard(pickup) {
    const card = document.createElement('div');
    card.className = 'glass-card p-4 border-l-4';
    const config = STATUS_CONFIG[pickup.status] || STATUS_CONFIG['Da Ritirare'];
    card.style.borderColor = config.border.replace('border-', '');
    const pickupDate = pickup.pickupDateTime ? new Date(pickup.pickupDateTime.seconds * 1000).toLocaleString('it-IT') : 'Da definire';
    
    let clientProposalHTML = '';
    if (pickup.status === 'Richiesta Inviata' && pickup.clientProposedDate) {
        const proposedDate = new Date(pickup.clientProposedDate.seconds * 1000).toLocaleString('it-IT');
        clientProposalHTML = `<div class="mt-2 p-2 bg-orange-900 bg-opacity-30 rounded-lg"><p class="font-semibold text-orange-300">Proposta cliente: ${proposedDate}</p></div>`;
    }
    
    let actionButtonsHTML = '';
    if (pickup.status === 'Richiesta Inviata') {
        actionButtonsHTML = `<div class="flex gap-2">
            <button onclick="window.proposeDates('${pickup.path}')" class="bg-yellow-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 transition">Controproponi</button>
            <button onclick="window.confirmClientDate('${pickup.path}')" class="btn-secondary text-sm font-bold py-2 px-3 rounded-lg">Conferma Data Cliente</button>
        </div>`;
    } else if (pickup.status === 'Programmato') {
        actionButtonsHTML = `<button onclick="window.markAsCompleted('${pickup.path}')" class="btn-secondary font-bold py-2 px-4 rounded-lg"><i class="fas fa-check mr-2"></i>Segna Completato</button>`;
    }
    
    const packagesText = Array.isArray(pickup.packages) && pickup.packages.length > 0
        ? pickup.packages.map((pkg, i) => `Collo ${i+1}: ${pkg.dimension || 'N/D'} - ${pkg.weight || 'N/D'}`).join('<br>')
        : 'N/D';

    let superAdminEmailHTML = '';
    if (isSuperAdmin) {
        superAdminEmailHTML = `
        <div class="mt-3 pt-3 border-t border-gray-700">
            <label for="email-input-${pickup.id}" class="text-sm font-medium text-gray-300">Email Notifiche Cliente:</label>
            <div class="flex gap-2 mt-1">
                <input type="email" id="email-input-${pickup.id}" value="${pickup.clientNotificationEmail || ''}" class="w-full p-2 rounded-lg transition" placeholder="Aggiungi email cliente...">
                <button onclick="window.updateClientEmail('${pickup.path}', '${pickup.id}')" class="btn-primary px-4 rounded-lg text-sm">Salva</button>
            </div>
        </div>`;
    }

    const footerHTML = `
        <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
            <div>${actionButtonsHTML}</div>
            <button onclick="window.deletePickup('${pickup.path}')" class="text-gray-400 hover:text-red-500 transition-colors duration-300 w-8 h-8 rounded-full hover:bg-red-900 hover:bg-opacity-50 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
        </div>
    `;

    let proposedDatesDisplay = 'Nessuna data proposta';
    if (Array.isArray(pickup.proposedDates) && pickup.proposedDates.length > 0) {
        proposedDatesDisplay = pickup.proposedDates.map(prop => new Date(prop.seconds * 1000).toLocaleString('it-IT')).join('<br>');
    }
    
    card.innerHTML = `
        <div class="flex flex-col md:flex-row justify-between">
            <div class="pr-8">
                <p class="font-bold text-lg">${pickup.clientName} / ${pickup.clientStand}</p>
                <p class="text-sm text-gray-400">${pickup.palletCount} colli - Codice: <span class="font-semibold">${pickup.uniqueCode}</span></p>
                ${clientProposalHTML}
                <p class="text-sm text-gray-500 italic mt-1">${pickup.clientNotes || ''}</p>
            </div>
            <div class="mt-4 md:mt-0 text-left md:text-right flex-shrink-0">
                <p class="font-semibold">Ritiro: <span class="font-normal">${pickupDate}</span></p>
                <p class="font-semibold mt-1"><span class="px-2 py-1 rounded-full text-xs ${config.color}">${config.text}</span></p>
            </div>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 text-sm">
            <div><i class="fas fa-box-open fa-fw text-gray-400 mr-2"></i><strong>Dettagli Colli:</strong><br><div class="pl-6">${packagesText}</div></div>
            <div><i class="fas fa-calendar-alt fa-fw text-gray-400 mr-2"></i><strong>Date Proposte:</strong><br><div class="pl-6">${proposedDatesDisplay}</div></div>
            <div class="md:col-span-2 mt-1"><i class="fas fa-map-marker-alt fa-fw text-gray-400 mr-2"></i><strong>Indirizzo:</strong> ${pickup.pickupAddress || 'N/D'}</div>
            <div class="md:col-span-2 mt-1"><i class="fas fa-user-tag fa-fw text-gray-400 mr-2"></i><strong>Referente:</strong> ${pickup.pickupContactName || 'N/D'} (${pickup.pickupContactPhone || 'N/D'})</div>
        </div>
        ${superAdminEmailHTML}
        ${footerHTML}
    `;
    return card;
}

// --- FUNZIONI ADMIN AGGIUNTE ---
window.showTab = (tabName) => {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
        button.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
    });

    document.getElementById(`tab-content-${tabName}`).style.display = 'block';
    document.getElementById(`tab-content-${tabName}`).classList.add('active');
    
    const activeButton = document.getElementById(`tab-${tabName}`);
    activeButton.classList.add('active');
    activeButton.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
};

window.deletePickup = (docPath) => {
    showModal(
        'Conferma Eliminazione',
        '<p>Sei sicuro di voler eliminare questo ritiro? L\'azione è irreversibile.</p>',
        async () => {
            try {
                await deleteDoc(doc(db, docPath));
                showToast('Ritiro eliminato con successo.');
                hideModal();
            } catch (e) {
                console.error("Errore eliminazione:", e);
                showToast("Errore durante l'eliminazione.", true);
                hideModal();
            }
        },
        'Elimina',
        'bg-red-600 text-white hover:bg-red-700'
    );
};

window.markAsCompleted = (docPath) => {
    showModal(
        'Conferma Completamento',
        '<p>Stai per segnare questo ritiro come completato. Vuoi procedere?</p>',
        async () => {
            try {
                await updateDoc(doc(db, docPath), { status: 'Completato' });
                showToast('Ritiro segnato come completato.');
                hideModal();
            } catch (e) {
                console.error("Errore completamento:", e);
                showToast("Errore durante l'aggiornamento.", true);
                hideModal();
            }
        },
        'Conferma',
        'btn-secondary'
    );
};

window.proposeDates = (docPath) => {
    const content = `
        <p class="mb-4">Aggiungi una o più date/ore da proporre al cliente.</p>
        <div id="proposals-container" class="space-y-3">
            <div class="proposal-row flex items-center gap-2">
                <input type="text" class="proposal-date-input flex-grow p-3 rounded-lg transition" placeholder="Seleziona Data">
                <input type="text" class="proposal-time-input flex-grow p-3 rounded-lg transition" placeholder="Seleziona Ora">
                <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-500 p-2 rounded-full hover:bg-red-900 hover:bg-opacity-50 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <button id="add-proposal-field" class="text-sm text-emotiva-purple hover:underline mt-4">+ Aggiungi un'altra data</button>
    `;

    const initializeProposalPickers = () => {
        document.querySelectorAll('.proposal-date-input:not(.flatpickr-input)').forEach(input => {
            flatpickr(input, {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                minDate: "today",
                locale: flatpickr.l10ns.it
            });
        });
        document.querySelectorAll('.proposal-time-input:not(.flatpickr-input)').forEach(input => {
            flatpickr(input, {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                locale: flatpickr.l10ns.it
            });
        });
    };

    showModal(
        'Proponi Date al Cliente',
        content,
        async () => {
            const proposalRows = document.querySelectorAll('.proposal-row');
            const proposedDates = [];
            let isValid = true;

            proposalRows.forEach(row => {
                const dateInput = row.querySelector('.proposal-date-input')._flatpickr.selectedDates[0];
                const timeInput = row.querySelector('.proposal-time-input')._flatpickr.selectedDates[0];

                if (dateInput && timeInput) {
                    const combinedDate = new Date(
                        dateInput.getFullYear(),
                        dateInput.getMonth(),
                        dateInput.getDate(),
                        timeInput.getHours(),
                        timeInput.getMinutes()
                    );

                    if (combinedDate > new Date()) {
                        proposedDates.push(combinedDate);
                    } else {
                        isValid = false;
                    }
                } else if (dateInput || timeInput) {
                    // Se solo uno dei due è compilato, non è valido
                    if (dateInput || timeInput) isValid = false;
                }
            });

            if (!isValid) {
                return showToast('Per ogni proposta, inserisci sia una data che un\'ora valide e future.', true);
            }

            if (proposedDates.length === 0) {
                return showToast('Inserisci almeno una proposta di data e ora valida.', true);
            }

            try {
                await updateDoc(doc(db, docPath), {
                    status: 'Date Proposte',
                    proposedDates: proposedDates,
                    clientProposedDate: null
                });
                showToast('Proposte inviate al cliente.');
                hideModal();
            } catch (e) {
                console.error("Errore proposta date:", e);
                showToast("Errore durante l'invio delle proposte.", true);
                hideModal();
            }
        },
        'Invia Proposte'
    );

    initializeProposalPickers();

    document.getElementById('add-proposal-field').onclick = () => {
        const container = document.getElementById('proposals-container');
        const newField = document.createElement('div');
        newField.className = 'proposal-row flex items-center gap-2 mt-3';
        newField.innerHTML = `
            <input type="text" class="proposal-date-input flex-grow p-3 rounded-lg transition" placeholder="Seleziona Data">
            <input type="text" class="proposal-time-input flex-grow p-3 rounded-lg transition" placeholder="Seleziona Ora">
            <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-500 p-2 rounded-full hover:bg-red-900 hover:bg-opacity-50 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(newField);
        initializeProposalPickers();
    };
};

window.confirmClientDate = async (docPath) => {
    try {
        const pickupDocRef = doc(db, docPath);
        const pickupDoc = await getDoc(pickupDocRef);

        if (!pickupDoc.exists() || !pickupDoc.data().clientProposedDate) {
            return showToast("Nessuna data proposta dal cliente da confermare.", true);
        }
        
        const clientDate = pickupDoc.data().clientProposedDate;

        const dateString = new Date(clientDate.seconds * 1000).toLocaleString('it-IT');
        showModal(
            'Conferma Data Cliente',
            `<p>Stai per confermare il ritiro per la data proposta dal cliente: <strong>${dateString}</strong>. Vuoi procedere?</p>`,
            async () => {
                await updateDoc(pickupDocRef, {
                    status: 'Programmato',
                    pickupDateTime: clientDate,
                    clientProposedDate: null,
                    proposedDates: [],
                    clientNotes: `Appuntamento confermato dal magazzino.`
                });
                showToast('Data del cliente confermata!');
                hideModal();
            },
            'Conferma',
            'btn-secondary'
        );

    } catch(e) {
        console.error("Error confirming client date:", e);
        showToast("Errore durante la conferma.", true);
        hideModal();
    }
};

window.updateClientEmail = async (docPath, pickupId) => {
    const emailInput = document.getElementById(`email-input-${pickupId}`);
    const newEmail = emailInput.value.trim();
    if (!newEmail) {
        showToast("Inserisci un indirizzo email valido.", true);
        return;
    }
    if (!/^\S+@\S+\.\S+$/.test(newEmail)) {
        showToast("Il formato dell'email non è valido.", true);
        return;
    }

    try {
        await updateDoc(doc(db, docPath), { clientNotificationEmail: newEmail });
        showToast("Email del cliente aggiornata!");
    } catch (e) {
        console.error("Errore aggiornamento email:", e);
        showToast("Errore durante l'aggiornamento.", true);
    }
};

// --- LOGICA LATO CLIENTE (MODIFICATA PER SICUREZZA) ---
window.loginClient = async () => {
    const clientCode = document.getElementById('client-code').value.trim().toUpperCase();
    const loginButton = document.getElementById('client-login-button');
    if (!clientCode) return showToast('Inserisci un codice di ritiro.', true);

    loginButton.disabled = true;
    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifica...';

    try {
        // Chiama la Cloud Function sicura per validare il codice
        const validateClientCode = httpsCallable(functions, 'validateClientCode');
        const result = await validateClientCode({ uniqueCode: clientCode });

        // Usa il token e il percorso del documento restituiti dalla funzione
        const { token, docPath } = result.data;
        
        // Autentica il client con il token personalizzato
        await signInWithCustomToken(auth, token);

        currentPickupDocPath = docPath; // Imposta il percorso per il listener
        listenForPickupClient();
        showView('client-view');

    } catch (error) {
        console.error("Client login failed:", error);
        showToast(error.message || 'Codice non valido o errore di rete.', true);
    } finally {
        loginButton.disabled = false;
        loginButton.innerHTML = 'Verifica Codice';
    }
};

function listenForPickupClient() {
    if (clientUnsubscribe) clientUnsubscribe();
    if (!currentPickupDocPath) return;

    clientUnsubscribe = onSnapshot(doc(db, currentPickupDocPath), (docSnapshot) => {
        if (docSnapshot.exists()) {
            renderClientView(docSnapshot.data());
        } else {
            showToast('Questo ritiro è stato cancellato.', true);
            logout();
        }
        sendHeight();
    });
}

function renderClientView(pickup) {
    const container = document.getElementById('client-content-area');
    document.getElementById('client-view-title').innerText = `Dettagli Ritiro: ${pickup.uniqueCode}`;
    const config = STATUS_CONFIG[pickup.status] || STATUS_CONFIG['Da Ritirare'];

    let packagesHTML = '';
    if (Array.isArray(pickup.packages) && pickup.packages.length > 0) {
        packagesHTML = `
            <div class="mt-3">
                <p><strong>Dettagli Colli:</strong></p>
                <div class="pl-4 mt-1 space-y-1 text-sm text-gray-400">
                    ${pickup.packages.map((pkg, i) => `
                        <p>
                            <span class="font-semibold text-gray-300">Collo ${i + 1}:</span>
                            Dimensioni: ${pkg.dimension || 'N/D'} | 
                            Peso: ${pkg.weight || 'N/D'}
                        </p>
                    `).join('')}
                </div>
            </div>`;
    }

    let contentHTML = `
        <div class="border-l-4 p-4 rounded-r-lg" style="border-color: ${config.border.replace('border-', '')};">
            <div class="flex flex-col sm:flex-row justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-white">${pickup.clientName} / ${pickup.clientStand}</h3>
                    <p class="text-sm text-gray-400">${pickup.palletCount} colli</p>
                </div>
                <span class="mt-2 sm:mt-0 px-3 py-1 rounded-full text-sm font-semibold ${config.color}">${config.text}</span>
            </div>
            <div class="space-y-3 text-gray-300">
                <p><strong>Descrizione:</strong> ${pickup.palletDesc || 'N/D'}</p>
                <p><strong>Indirizzo Ritiro:</strong> ${pickup.pickupAddress}</p>
                ${packagesHTML}
            </div>
            <div id="client-action-area" class="mt-6 pt-6 border-t border-gray-700"></div>
        </div>
    `;
    container.innerHTML = contentHTML;

    const actionArea = document.getElementById('client-action-area');
    let actionHTML = '';

    switch (pickup.status) {
        case 'Date Proposte':
            actionHTML = `<h4 class="text-lg font-semibold mb-3 text-white">Il magazzino ha proposto le seguenti date. Selezionane una:</h4>`;
            if (Array.isArray(pickup.proposedDates) && pickup.proposedDates.length > 0) {
                actionHTML += '<div class="space-y-2">';
                pickup.proposedDates.forEach((proposal, index) => {
                    const date = new Date(proposal.seconds * 1000);
                    actionHTML += `
                        <label for="proposal-${index}" class="flex items-center p-3 rounded-lg bg-gray-900 bg-opacity-50 hover:bg-gray-700 cursor-pointer transition">
                            <input type="radio" id="proposal-${index}" name="date-proposal" value="${proposal.seconds}" class="w-4 h-4 text-emotiva-purple bg-gray-700 border-gray-600 focus:ring-emotiva-purple">
                            <span class="ml-3 text-white">${date.toLocaleString('it-IT', { dateStyle: 'full', timeStyle: 'short' })}</span>
                        </label>
                    `;
                });
                actionHTML += '</div>';
                actionHTML += `<div class="mt-4 flex flex-col sm:flex-row gap-4">
                                <button onclick="window.confirmSlot()" class="btn-secondary font-bold py-2 px-5 rounded-lg">Conferma Appuntamento</button>
                                <button onclick="window.rejectAndRepropose()" class="bg-gray-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-500">Nessuna va bene, propongo io</button>
                               </div>`;
            } else {
                actionHTML += '<p class="text-gray-400">Nessuna proposta al momento. Attendi una comunicazione dal magazzino.</p>';
            }
            break;

        case 'Programmato':
            const pickupDate = new Date(pickup.pickupDateTime.seconds * 1000);
            actionHTML = `
                <h4 class="text-lg font-semibold text-white">Appuntamento Confermato!</h4>
                <p class="text-2xl my-2 text-emotiva-green">${pickupDate.toLocaleString('it-IT', { dateStyle: 'full', timeStyle: 'short' })}</p>
                <p class="text-gray-400 mb-4">Il ritiro è stato programmato per questa data e ora.</p>
                <button onclick="window.requestReschedule()" class="border border-red-500 text-red-400 font-bold py-2 px-4 rounded-lg hover:bg-red-500 hover:text-white transition">Ho un problema, devo modificare</button>
            `;
            break;
            
        case 'Da Ritirare':
        case 'Richiesta Inviata':
            if (pickup.clientProposedDate) {
                const proposedDate = new Date(pickup.clientProposedDate.seconds * 1000);
                actionHTML = `
                    <h4 class="text-lg font-semibold mb-3 text-white">Proposta Inviata</h4>
                    <p class="text-gray-300">Hai proposto il ritiro per il giorno:</p>
                    <p class="text-xl my-2 text-emotiva-purple">${proposedDate.toLocaleString('it-IT', { dateStyle: 'full', timeStyle: 'short' })}</p>
                    <p class="text-gray-400">Il magazzino sta valutando la tua richiesta. Riceverai una notifica non appena sarà confermata o se ci saranno delle controproposte.</p>
                `;
            } else {
                actionHTML = `
                    <h4 class="text-lg font-semibold mb-3 text-white">Proponi una data e un'ora per il ritiro</h4>
                    <p class="text-gray-400 mb-4">Il magazzino valuterà la tua proposta e ti darà conferma o ti invierà delle alternative.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="client-reproposed-date-picker" class="p-3 rounded-lg transition" placeholder="Seleziona Data">
                        <input type="text" id="client-reproposed-time-picker" class="p-3 rounded-lg transition" placeholder="Seleziona Ora">
                    </div>
                    <textarea id="client-notes-input" class="w-full p-3 rounded-lg transition mt-4" placeholder="Aggiungi una nota (opzionale)"></textarea>
                    <button onclick="window.proposeDateClient()" class="w-full mt-4 btn-secondary font-bold py-3 px-6 rounded-lg whitespace-nowrap">Invia Proposta</button>
                `;
                if (pickup.clientNotes) {
                     actionHTML += `<div class="mt-4 p-3 bg-gray-900 bg-opacity-50 rounded-lg"><p class="text-sm italic text-gray-300"><b>Tue note precedenti:</b> ${pickup.clientNotes}</p></div>`;
                }
                setTimeout(() => {
                    flatpickr("#client-reproposed-date-picker", { altInput: true, altFormat: "d/m/Y", dateFormat: "Y-m-d", minDate: "today", locale: flatpickr.l10ns.it });
                    flatpickr("#client-reproposed-time-picker", { enableTime: true, noCalendar: true, dateFormat: "H:i", locale: flatpickr.l10ns.it });
                }, 0);
            }
            break;

        case 'Completato':
            actionHTML = `<h4 class="text-lg font-semibold text-green-400">Ritiro Completato</h4><p class="text-gray-300">Questo ritiro è stato completato con successo. Grazie!</p>`;
            break;
    }
    actionArea.innerHTML = actionHTML;
}

window.proposeDateClient = async () => {
    const dateInput = document.getElementById('client-reproposed-date-picker')._flatpickr.selectedDates[0];
    const timeInput = document.getElementById('client-reproposed-time-picker')._flatpickr.selectedDates[0];
    const notes = document.getElementById('client-notes-input').value;

    if (!dateInput || !timeInput) {
        return showToast('Per favore, seleziona sia una data che un\'ora.', true);
    }

    const proposedDate = new Date(
        dateInput.getFullYear(),
        dateInput.getMonth(),
        dateInput.getDate(),
        timeInput.getHours(),
        timeInput.getMinutes()
    );

    if (proposedDate < new Date()) {
        return showToast('La data proposta non può essere nel passato.', true);
    }
    if (!currentPickupDocPath) return showToast('Errore, ricarica la pagina.', true);

    try {
        await updateDoc(doc(db, currentPickupDocPath), {
            status: 'Richiesta Inviata',
            clientProposedDate: proposedDate,
            clientNotes: notes,
            pickupDateTime: null,
            proposedDates: []
        });
        showToast('La tua proposta è stata inviata!');
    } catch (e) {
        console.error("Error proposing date:", e);
        showToast('Si è verificato un errore.', true);
    }
};

window.confirmSlot = async () => {
    const selectedRadio = document.querySelector('input[name="date-proposal"]:checked');
    if (!selectedRadio) return showToast('Per favore, seleziona una data.', true);
    
    const selectedTimestamp = parseInt(selectedRadio.value, 10);
    const confirmedDate = new Date(selectedTimestamp * 1000);

    if (!currentPickupDocPath) return showToast('Errore, ricarica la pagina.', true);

    try {
        await updateDoc(doc(db, currentPickupDocPath), {
            status: 'Programmato',
            pickupDateTime: confirmedDate,
            clientProposedDate: null,
            proposedDates: [],
            clientNotes: 'Appuntamento confermato dal cliente.'
        });
        showToast('Appuntamento confermato con successo!');
    } catch (e) {
        console.error("Error confirming date:", e);
        showToast('Si è verificato un errore.', true);
    }
};

window.requestReschedule = () => {
    const content = `<p>Vuoi richiedere una modifica? L'appuntamento verrà annullato e potrai proporre una nuova data.</p><textarea id="reschedule-reason" class="w-full p-2 border rounded mt-4" placeholder="Motivo (opzionale)"></textarea>`;
    showModal('Richiedi Modifica Ritiro', content, async () => {
        const reason = document.getElementById('reschedule-reason').value;
        const note = `RICHIESTA DI RIPROGRAMMAZIONE. ${reason ? 'Motivo: ' + reason : ''}`;
        if (!currentPickupDocPath) {
            showToast("Errore: Riferimento al ritiro non trovato. Riprova l'accesso.", true);
            hideModal();
            return;
        }
        try {
            await updateDoc(doc(db, currentPickupDocPath), {
                status: 'Da Ritirare',
                pickupDateTime: null,
                proposedDates: [],
                clientProposedDate: null,
                clientNotes: note
            });
            showToast('Richiesta inviata. Proponi una nuova data.');
            hideModal();
        } catch(e) { console.error(e); showToast('Errore. Riprova.', true); }
    }, 'Conferma Richiesta');
};

window.rejectAndRepropose = () => {
    const content = `
        <p class="mb-4">Proponi una nuova data e ora per il ritiro:</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="client-reproposed-date-picker" class="p-3 rounded-lg transition" placeholder="Seleziona Data">
            <input type="text" id="client-reproposed-time-picker" class="p-3 rounded-lg transition" placeholder="Seleziona Ora">
        </div>
        <textarea id="reproposal-notes" class="w-full p-3 rounded-lg transition mt-4" placeholder="Note (opzionale)"></textarea>
    `;
    
    showModal('Proponi una Nuova Data', content, async () => {
        const dateInput = document.getElementById('client-reproposed-date-picker')._flatpickr.selectedDates[0];
        const timeInput = document.getElementById('client-reproposed-time-picker')._flatpickr.selectedDates[0];
        const notes = document.getElementById('reproposal-notes').value;

        if (!dateInput || !timeInput) {
            return showToast("Per favore, seleziona sia una data che un'ora.", true);
        }

        const newProposedDate = new Date(
            dateInput.getFullYear(),
            dateInput.getMonth(),
            dateInput.getDate(),
            timeInput.getHours(),
            timeInput.getMinutes()
        );

        if (newProposedDate < new Date()) {
            return showToast("La data proposta non può essere nel passato.", true);
        }

        if (!currentPickupDocPath) {
            showToast("Errore: Riferimento al ritiro non trovato. Riprova l'accesso.", true);
            hideModal();
            return;
        }
        try {
            await updateDoc(doc(db, currentPickupDocPath), {
                status: 'Richiesta Inviata',
                clientNotes: 'Controproposta del cliente: ' + notes,
                clientProposedDate: newProposedDate,
                proposedDates: [],
            });
            showToast('Nuova proposta inviata!');
            hideModal();
        } catch(e) { console.error(e); showToast("Errore. Riprova.", true); }
    }, 'Invia Nuova Proposta');

    // Inizializza i selettori di data/ora dopo aver mostrato il modale
    flatpickr("#client-reproposed-date-picker", { altInput: true, altFormat: "d/m/Y", dateFormat: "Y-m-d", minDate: "today", locale: flatpickr.l10ns.it });
    flatpickr("#client-reproposed-time-picker", { enableTime: true, noCalendar: true, dateFormat: "H:i", locale: flatpickr.l10ns.it });
};

// --- FINE LOGICA LATO CLIENTE ---

const observer = new MutationObserver(sendHeight);
observer.observe(document.getElementById('main-content-wrapper'), {
    childList: true,
    subtree: true,
    attributes: true
});
window.addEventListener('load', sendHeight);
window.addEventListener('resize', sendHeight);
setTimeout(sendHeight, 500);
</script>
</body>
</html>
